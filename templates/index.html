<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-pulse { animation: pulse 1.5s infinite; }
        .modal-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #loadingSpinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .scrollable-modal {
            max-height: 400px; /* Fixed height for modal */
            overflow-y: auto; /* Enable vertical scrollbar */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Document Analyzer</h1>
    
        <!-- File selection -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
            <input type="file" id="fileInput" accept=".txt,.pdf,.docx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <p id="fileName" class="mt-2 text-sm text-gray-600">No file selected</p>
        </div>

        <!-- File History -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-bold mb-4 text-gray-800">File History</h2>
            <ul id="fileHistory" class="list-disc pl-5 space-y-2 text-gray-700"></ul>
        </div>
        
        <!-- Preview area -->
        <div id="previewArea" class="bg-white p-6 rounded-lg shadow mb-6 h-96 overflow-y-auto">
            <p id="textPreview" class="hidden whitespace-pre-wrap"></p>
            <div id="imagePreview"></div>
        </div>
        
        <!-- Buttons -->
        <div class="flex flex-wrap justify-center space-x-4 space-y-2 md:space-y-0">
            <select id="convertFormat" class="border border-gray-300 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select format</option>
                <option value="pdf">PDF</option>
                <option value="docx">DOCX</option>
                <option value="txt">TXT</option>
            </select>
            <button id="convertBtn" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition duration-200">Convert Format</button>
            <button id="summaryBtn" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition duration-200">Make Summary</button>
            <button id="emotionBtn" class="bg-purple-500 text-white px-6 py-2 rounded-md hover:bg-purple-600 transition duration-200">Find Emotions</button>
            <button id="voiceBtn" class="bg-yellow-500 text-white px-6 py-2 rounded-md hover:bg-yellow-600 transition duration-200 flex items-center">
                <i class="fas fa-microphone mr-2"></i> Voice Command
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Modal for summary results -->
    <div id="summaryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4 modal-content scrollable-modal">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Summary</h2>
            <div id="summaryContent" class="space-y-4 text-gray-700 mb-6">
                <!-- Summary will be populated here -->
            </div>
            <div class="flex justify-between">
                <button id="deepDiveBtn" class="bg-indigo-500 text-white px-6 py-2 rounded-md hover:bg-indigo-600 transition duration-200">Deep Dive</button>
                <button id="closeSummaryModal" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for emotion results -->
    <div id="emotionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4 modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Sentiment Analysis Results</h2>
            <div id="emotionResults" class="space-y-4 mb-6">
                <!-- Results will be populated here -->
            </div>
            <canvas id="sentimentChart" class="mt-4"></canvas>
            <button id="closeEmotionModal" class="mt-6 w-full bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition duration-200">Close</button>
        </div>
    </div>

    <script>
        let currentText = '';
        let currentFile = null;
        let sentimentChart = null;
        let currentSummaryLength = 3; // Initial summary length (top 3 sentences)
        let fileHistory = JSON.parse(localStorage.getItem('fileHistory')) || [];

        // Load file history on page load
        function loadFileHistory() {
            const historyList = document.getElementById('fileHistory');
            historyList.innerHTML = '';
            fileHistory.forEach(file => {
                const li = document.createElement('li');
                li.textContent = file;
                historyList.appendChild(li);
            });
            if (fileHistory.length === 0) {
                historyList.innerHTML = '<li>No files uploaded yet.</li>';
            }
        }
        loadFileHistory();

        // Add to history
        function addToHistory(filename) {
            if (!fileHistory.includes(filename)) {
                fileHistory.push(filename);
                localStorage.setItem('fileHistory', JSON.stringify(fileHistory));
                loadFileHistory();
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length === 0) return;
            currentFile = e.target.files[0];
            document.getElementById('fileName').textContent = currentFile.name;
            
            const formData = new FormData();
            formData.append('file', currentFile);
            
            // Show spinner
            document.getElementById('loadingSpinner').style.display = 'flex';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                document.getElementById('loadingSpinner').style.display = 'none';

                if (data.error) {
                    alert(data.error);
                    return;
                }
                currentText = data.text;
                const textPreview = document.getElementById('textPreview');
                const imagePreview = document.getElementById('imagePreview');
                
                textPreview.classList.add('hidden');
                imagePreview.innerHTML = '';
                
                if (data.preview_type === 'text') {
                    textPreview.textContent = data.preview_content;
                    textPreview.classList.remove('hidden');
                } else if (data.preview_type === 'image') {
                    data.preview_content.forEach(img => {
                        const imgElement = document.createElement('img');
                        imgElement.src = `data:image/png;base64,${img}`;
                        imgElement.className = 'mb-4 max-w-full rounded-lg shadow';
                        imagePreview.appendChild(imgElement);
                    });
                }
                // Add to history
                addToHistory(currentFile.name);
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error uploading file: ' + error);
            });
        });

        document.getElementById('convertBtn').addEventListener('click', function() {
            if (!currentFile) {
                alert('Please select a file first!');
                return;
            }
            const format = document.getElementById('convertFormat').value;
            if (!format) {
                alert('Please select a format to convert to!');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('format', format);
            
            // Show spinner
            document.getElementById('loadingSpinner').style.display = 'flex';

            fetch('/convert', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (data.error) {
                    alert(data.error);
                    return;
                }
                const link = document.createElement('a');
                link.href = `data:application/${format};base64,${data.file_data}`;
                link.download = data.filename;
                link.click();
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error converting file: ' + error);
            });
        });

        document.getElementById('summaryBtn').addEventListener('click', function() {
            if (!currentText) {
                alert('No text to summarize!');
                return;
            }
            
            generateSummary(currentSummaryLength);
        });

        function generateSummary(numSentences) {
            // Show spinner
            document.getElementById('loadingSpinner').style.display = 'flex';

            fetch('/summarize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: currentText, num_sentences: numSentences})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (data.error) {
                    alert(data.error);
                    return;
                }
                const modal = document.getElementById('summaryModal');
                const content = document.getElementById('summaryContent');
                content.innerHTML = `
                    <p class="text-lg leading-relaxed">${data.summary}</p>
                `;
                modal.classList.remove('hidden');
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error generating summary: ' + error);
            });
        }

        document.getElementById('deepDiveBtn').addEventListener('click', function() {
            currentSummaryLength = 5; // Increase to top 5 sentences for deep dive
            generateSummary(currentSummaryLength);
        });

        document.getElementById('closeSummaryModal').addEventListener('click', function() {
            document.getElementById('summaryModal').classList.add('hidden');
            currentSummaryLength = 3; // Reset to default
        });

        document.getElementById('emotionBtn').addEventListener('click', function() {
            if (!currentText) {
                alert('No text to analyze!');
                return;
            }
            
            // Show spinner
            document.getElementById('loadingSpinner').style.display = 'flex';

            fetch('/emotion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: currentText})
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (data.error) {
                    alert(data.error);
                    return;
                }
                const modal = document.getElementById('emotionModal');
                const resultsDiv = document.getElementById('emotionResults');
                resultsDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <i class="fas fa-smile text-green-500 text-3xl mr-3 animate-bounce"></i>
                        <p class="text-lg">Positive: ${data.positive}</p>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fas fa-frown text-red-500 text-3xl mr-3 animate-bounce"></i>
                        <p class="text-lg">Negative: ${data.negative}</p>
                    </div>
                    <div class="flex items-center mb-2">
                        <i class="fas fa-meh text-blue-500 text-3xl mr-3 animate-bounce"></i>
                        <p class="text-lg">Neutral: ${data.neutral}</p>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-tachometer-alt text-purple-500 text-3xl mr-3 animate-pulse"></i>
                        <p class="text-lg">Compound: ${data.compound}</p>
                    </div>
                `;
                
                // Update chart
                if (sentimentChart) {
                    sentimentChart.destroy();
                }
                const ctx = document.getElementById('sentimentChart').getContext('2d');
                sentimentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Positive', 'Negative', 'Neutral'],
                        datasets: [{
                            label: 'Sentiment Scores',
                            data: [
                                parseFloat(data.positive),
                                parseFloat(data.negative),
                                parseFloat(data.neutral)
                            ],
                            backgroundColor: ['#34D399', '#EF4444', '#3B82F6'],
                            borderColor: ['#059669', '#B91C1C', '#1E40AF'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'Percentage (%)' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Sentiment Analysis' }
                        }
                    }
                });
                
                modal.classList.remove('hidden');
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('Error analyzing emotions: ' + error);
            });
        });

        document.getElementById('closeEmotionModal').addEventListener('click', function() {
            document.getElementById('emotionModal').classList.add('hidden');
            if (sentimentChart) {
                sentimentChart.destroy();
                sentimentChart = null;
            }
        });

        // Voice Command Functionality
        const voiceBtn = document.getElementById('voiceBtn');
        let recognition = null;

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i> Listening...';
                voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            };

            recognition.onend = () => {
                voiceBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i> Voice Command';
                voiceBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                if (transcript.includes('make summary') || transcript.includes('create summary') || transcript.includes('summarize')) {
                    document.getElementById('summaryBtn').click();
                } else if (transcript.includes('find emotion') || transcript.includes('find emotions') || transcript.includes('emotion analysis') || transcript.includes('analyze emotions')) {
                    document.getElementById('emotionBtn').click();
                } else {
                    alert('Command not recognized: ' + transcript);
                }
            };

            recognition.onerror = (event) => {
                alert('Voice recognition error: ' + event.error);
            };
        } else {
            voiceBtn.disabled = true;
            voiceBtn.title = 'Voice recognition not supported in this browser.';
        }

        voiceBtn.addEventListener('click', () => {
            if (recognition) {
                recognition.start();
            }
        });
    </script>
</body>
</html>